/*
 * File: main.js
 *
 * Copyright (c) 2009, Paulo Avila (apaulodesign.com)
 *
 * Project: Page Capture Widget
 * Author: Paulo Avila
 *
 * Description: Main function declarations for the operation
 *  of the Page Capture widget (webpage to bitmap capturing).
 *
 */

var g_cmd=null;var g_spinner=null;function w_init(){w_registerHandlers();w_loadSavedPrefs();}function w_doCapture(){var b="";var a=wr_eId("uri").value;if(a===""){return;}b="/usr/bin/python ~/Library/Widgets/Page\\ Capture.wdgt/Assets/webkit2png-0.5.sh";b+=" --width=1024";b+=" --dir=~/Desktop/";b+=" --thumb";b+=" --scale="+wr_eId("width").value;a=encodeURI((a.indexOf("http://")===0||a.indexOf("https://")===0)?a:"http://"+a);a=a.replace(/%25/,"%");wr_setPref(a,wr_instance("uri"));wr_eId("uri").value=a;b+=" "+wr_escapeCLI(a);wr_eId("uri").disabled=true;wr_eId("start").onclick=null;wr_eId("width").disabled=true;wr_eId("infoText").innerHTML="Page Capture engine loading...";wr_eId("infoImage").style.backgroundPositionY="0";g_spinner=setInterval(function(){w_shiftSpinner();},75);wr_eId("infoImage").style.appleDashboardRegion="dashboard-region(control circle)";if(window.widget){g_cmd=widget.system(b,w_finishCapture);g_cmd.onreadoutput=w_outputHandler;}}function w_cancelCapture(){if(g_cmd){g_cmd.cancel();clearInterval(g_spinner);wr_eId("infoImage").style.appleDashboardRegion="";wr_eId("infoImage").style.backgroundPositionY="-"+(13*15)+"px";wr_eId("infoText").innerHTML="Cancelled.";}wr_eId("uri").disabled=false;wr_eId("start").onclick=w_doCapture;wr_eId("width").disabled=false;g_cmd=null;}function w_finishCapture(){clearInterval(g_spinner);wr_eId("infoImage").style.appleDashboardRegion="";wr_eId("infoImage").style.backgroundPositionY="-"+(/^<filename>Page Capture \d+<\/filename> saved to your Desktop\.\n$/.test(wr_eId("infoText").innerHTML)?(14*15):(13*15))+"px";if(g_cmd.status!==0){wr_eId("infoText").innerHTML="Error detected.";}wr_eId("uri").disabled=false;wr_eId("start").onclick=w_doCapture;wr_eId("width").disabled=false;g_cmd=null;}function w_outputHandler(a){wr_eId("infoText").innerHTML=a;}function w_shiftSpinner(){var c=-15;var b=parseInt(document.defaultView.getComputedStyle(wr_eId("infoImage"),null).getPropertyValue("background-position-y"),10);var a=b/c;wr_eId("infoImage").style.backgroundPositionY=((a===12)?c:(b+c))+"px";}function w_versionCheck(){var g;var d=0;var a=1;var e=2;var b=3;var j=4;var i=200;var h=404;var c="http://www.apaulodesign.com/widgets/version.php?s="+wr_getPlistValue("CFBundleIdentifier").wr_ext();var f=new XMLHttpRequest();wr_eId("version").onclick=null;wr_eId("version").innerHTML="&thinsp;.&thinsp;.&thinsp;.";f.open("GET",c);f.setRequestHeader("Cache-Control","no-cache");f.onreadystatechange=function(){if(f.readyState==j){if(f.status==i){if(f.responseText!==null&&f.responseText!==""){g=f.responseText.split("|",1);if(wr_getPlistValue("CFBundleVersion")!==g[0]){wr_eId("version").innerHTML="Get";wr_eId("version").className="link";wr_eId("version").onclick=function(){wr_openURL();};}else{wr_eId("version").onclick=w_versionCheck;wr_eId("version").className="idle";wr_eId("version").innerHTML="v"+wr_getPlistValue("CFBundleVersion");}}else{}}}};f.send(null);}function w_loadSavedPrefs(){var b=wr_getPref(wr_instance("uri"));var a=wr_getPref(wr_instance("width"));if(b){wr_eId("uri").value=b;}if(a){wr_eId("width").value=a;}}function w_registerHandlers(){if(arguments.callee.done){return;}else{arguments.callee.done=true;}var a=new AppleInfoButton(wr_eId("infoButton"),wr_eId("front"),"white","black",wr_showBack);var b=new AppleGlassButton(wr_eId("doneButton"),wr_localize("Done"),function(){wr_eId("version").onclick=w_versionCheck;wr_eId("version").className="idle";wr_eId("version").innerHTML="v"+wr_getPlistValue("CFBundleVersion");wr_showFront();});wr_eId("uri").onkeypress=function(){if(event.keyCode===3||event.keyCode===13){w_doCapture();}};wr_eId("start").onclick=w_doCapture;wr_eId("infoImage").onmouseover=function(){wr_eId("infoImage").className="mouseover";};wr_eId("infoImage").onmouseout=function(){wr_eId("infoImage").className="mouseout";};wr_eId("infoImage").onclick=function(){if(wr_eId("uri").disabled){w_cancelCapture();}};wr_eId("width").onchange=function(){wr_setPref(wr_eId("width").value,wr_instance("width"));};wr_eId("logo").onclick=function(){wr_openURL();};wr_eId("version").innerHTML="v"+wr_getPlistValue("CFBundleVersion");wr_eId("version").onclick=w_versionCheck;window.onblur=function(){wr_eId("uri").blur();};if(window.widget){widget.onshow=function(){if(wr_eId("uri").disabled){g_spinner=setInterval(function(){w_shiftSpinner();},75);}};widget.onhide=function(){clearInterval(g_spinner);};widget.onremove=function(){w_cancelCapture();wr_setPref(null,wr_instance("width"));wr_setPref(null,wr_instance("uri"));};}}
